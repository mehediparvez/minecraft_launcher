/**
 * Microsoft Authentication Module for Void Client
 * Handles the OAuth2 flow and token acquisition for Minecraft authentication
 */

const { PublicClientApplication } = require('@azure/msal-node');
const fetch = require('node-fetch');
const keytar = require('keytar');
const { msalConfig, loginRequest, xboxLiveConfig } = require('./config');
const { ipcMain, BrowserWindow } = require('electron');
const path = require('path');

// Service name for keytar credential storage
const SERVICE_NAME = 'VoidClientMinecraft';
const ACCOUNT_NAME = 'MinecraftAccount';

class MinecraftAuthProvider {
    constructor() {
        this.msalClient = new PublicClientApplication(msalConfig);
        this.account = null;
        this.minecraftTokenData = null;
    }

    /**
     * Initialize authentication and register IPC handlers
     */
    init() {
        this.registerIpcHandlers();
        return this.loadSavedCredentials();
    }

    /**
     * Register IPC handlers for renderer process communication
     */
    registerIpcHandlers() {
        ipcMain.handle('minecraft:login', async () => {
            try {
                const result = await this.login();
                return { success: true, profile: result };
            } catch (error) {
                console.error('Authentication error:', error);
                return { success: false, error: error.message };
            }
        });

        ipcMain.handle('minecraft:logout', async () => {
            try {
                await this.logout();
                return { success: true };
            } catch (error) {
                console.error('Logout error:', error);
                return { success: false, error: error.message };
            }
        });

        ipcMain.handle('minecraft:getProfile', async () => {
            try {
                if (!this.minecraftTokenData) {
                    throw new Error('Not authenticated');
                }
                const profile = await this.getMinecraftProfile();
                return { success: true, profile };
            } catch (error) {
                console.error('Get profile error:', error);
                return { success: false, error: error.message };
            }
        });
    }

    /**
     * Create authentication window for Microsoft login
     */
    createAuthWindow() {
        return new Promise(async (resolve, reject) => {
            const authCodeUrlParameters = {
                ...loginRequest,
                redirectUri: msalConfig.auth.redirectUri,
                prompt: 'select_account'
            };

            console.log("Starting Microsoft authentication...");
            
            try {
                const authCodeUrl = await this.msalClient.getAuthCodeUrl(authCodeUrlParameters);
                
                const authWindow = new BrowserWindow({
                    width: 1024,
                    height: 768,
                    show: true,
                    center: true,
                    webPreferences: {
                        nodeIntegration: false,
                        contextIsolation: true,
                        enableRemoteModule: false
                    },
                    autoHideMenuBar: true,
                    title: "Microsoft Authentication - Void Client"
                });
                
                console.log("Auth window created, loading URL:", authCodeUrl);

                // Monitor all URL changes
                authWindow.webContents.on('did-navigate', (event, url) => {
                    console.log("Navigation detected to:", url);
                    checkForAuthCode(url);
                });

                authWindow.webContents.on('will-redirect', (event, url) => {
                    console.log("Redirect detected to:", url);
                    checkForAuthCode(url);
                });

                authWindow.webContents.on('will-navigate', (event, url) => {
                    console.log("Will navigate to:", url);
                    checkForAuthCode(url);
                });

                // Helper function to check for auth code
                const checkForAuthCode = (url) => {
                    try {
                        if (url && url.startsWith(msalConfig.auth.redirectUri)) {
                            const parsedUrl = new URL(url);
                            const code = parsedUrl.searchParams.get('code');
                            if (code) {
                                console.log("Auth code received, closing window");
                                authWindow.removeAllListeners('closed');
                                authWindow.destroy();
                                resolve(code);
                            } else if (parsedUrl.searchParams.get('error')) {
                                const error = parsedUrl.searchParams.get('error');
                                const errorDesc = parsedUrl.searchParams.get('error_description');
                                console.log("Auth error:", error, errorDesc);
                                authWindow.removeAllListeners('closed');
                                authWindow.destroy();
                                reject(new Error(`Authentication failed: ${error} - ${errorDesc}`));
                            }
                        }
                    } catch (err) {
                        console.error("Error parsing URL:", err);
                    }
                };

                authWindow.on('closed', () => {
                    console.log("Auth window was closed by user");
                    reject(new Error('Authentication window was closed'));
                });
                
                // Handle load errors
                authWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription) => {
                    console.log("Page failed to load:", errorCode, errorDescription);
                    if (errorCode !== -3) { // Ignore ERR_ABORTED errors which happen during redirects
                        reject(new Error(`Page failed to load: ${errorDescription}`));
                        authWindow.destroy();
                    }
                });

                await authWindow.loadURL(authCodeUrl);
            } catch (err) {
                console.error("Error during authentication:", err);
                reject(err);
            }
        });
    }

    /**
     * Initiate login process
     */
    async login() {
        try {
            console.log("Starting login flow...");
            
            // Get auth code through popup window
            const authCode = await this.createAuthWindow();
            console.log("Auth code obtained successfully");
            
            // Exchange auth code for token
            console.log("Exchanging auth code for token...");
            const tokenResponse = await this.msalClient.acquireTokenByCode({
                code: authCode,
                scopes: loginRequest.scopes,
                redirectUri: msalConfig.auth.redirectUri
            });
            
            if (!tokenResponse) {
                console.error("No token response received");
                throw new Error('No token response received');
            }
            console.log("Token obtained successfully");

            this.account = tokenResponse.account;
            
            // Xbox Live authentication
            console.log("Authenticating with Xbox Live...");
            const xboxLiveToken = await this.authenticateWithXboxLive(tokenResponse.accessToken);
            console.log("Xbox Live authentication successful");
            
            // XSTS authentication
            console.log("Getting XSTS token...");
            const xstsToken = await this.getXSTSToken(xboxLiveToken);
            console.log("XSTS token obtained successfully");
            
            // Minecraft authentication
            console.log("Authenticating with Minecraft...");
            const minecraftToken = await this.authenticateWithMinecraft(xstsToken);
            console.log("Minecraft authentication successful");
            
            // Get Minecraft profile
            console.log("Retrieving Minecraft profile...");
            const profile = await this.getMinecraftProfile(minecraftToken.access_token);
            console.log("Minecraft profile retrieved successfully:", profile.name);
            
            // Save credentials
            console.log("Saving credentials...");
            await this.saveCredentials(minecraftToken);
            console.log("Credentials saved successfully");
            
            // Return user profile
            return profile;
        } catch (error) {
            console.error('Authentication error:', error);
            throw error;
        }
    }

    /**
     * Authenticate with Xbox Live using Microsoft access token
     */
    async authenticateWithXboxLive(accessToken) {
        const response = await fetch(xboxLiveConfig.urlXboxLiveAuth, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                Properties: {
                    AuthMethod: 'RPS',
                    SiteName: 'user.auth.xboxlive.com',
                    RpsTicket: `d=${accessToken}`
                },
                RelyingParty: 'http://auth.xboxlive.com',
                TokenType: 'JWT'
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(`Xbox Live authentication failed: ${JSON.stringify(data)}`);
        }

        return data.Token;
    }

    /**
     * Get XSTS token using Xbox Live token
     */
    async getXSTSToken(xboxLiveToken) {
        const response = await fetch(xboxLiveConfig.urlXboxLiveXsts, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                Properties: {
                    SandboxId: 'RETAIL',
                    UserTokens: [xboxLiveToken]
                },
                RelyingParty: 'rp://api.minecraftservices.com/',
                TokenType: 'JWT'
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(`XSTS authentication failed: ${JSON.stringify(data)}`);
        }

        // Return both the token and user hash
        return {
            token: data.Token,
            userHash: data.DisplayClaims.xui[0].uhs
        };
    }

    /**
     * Authenticate with Minecraft using XSTS token
     */
    async authenticateWithMinecraft({ token, userHash }) {
        const response = await fetch(xboxLiveConfig.urlMinecraftAuth, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                identityToken: `XBL3.0 x=${userHash};${token}`
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(`Minecraft authentication failed: ${JSON.stringify(data)}`);
        }

        // Save the token data for future use
        this.minecraftTokenData = data;
        return data;
    }

    /**
     * Get Minecraft profile information
     */
    async getMinecraftProfile(accessToken = null) {
        const token = accessToken || (this.minecraftTokenData ? this.minecraftTokenData.access_token : null);
        
        if (!token) {
            throw new Error('No access token available');
        }

        const response = await fetch('https://api.minecraftservices.com/minecraft/profile', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(`Failed to get Minecraft profile: ${JSON.stringify(data)}`);
        }

        return data;
    }

    /**
     * Check if user owns Minecraft
     */
    async checkGameOwnership(accessToken = null) {
        const token = accessToken || (this.minecraftTokenData ? this.minecraftTokenData.access_token : null);
        
        if (!token) {
            throw new Error('No access token available');
        }

        const response = await fetch('https://api.minecraftservices.com/entitlements/mcstore', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(`Failed to check game ownership: ${JSON.stringify(data)}`);
        }

        return data.items && data.items.length > 0;
    }

    /**
     * Save credentials securely
     */
    async saveCredentials(tokenData) {
        if (!tokenData) return;
        
        try {
            await keytar.setPassword(
                SERVICE_NAME, 
                ACCOUNT_NAME, 
                JSON.stringify(tokenData)
            );
            this.minecraftTokenData = tokenData;
        } catch (error) {
            console.error('Failed to save credentials:', error);
            throw error;
        }
    }

    /**
     * Load saved credentials
     */
    async loadSavedCredentials() {
        try {
            const tokenData = await keytar.getPassword(SERVICE_NAME, ACCOUNT_NAME);
            if (tokenData) {
                this.minecraftTokenData = JSON.parse(tokenData);
                
                // Check if token is still valid
                try {
                    const profile = await this.getMinecraftProfile();
                    return profile;
                } catch (error) {
                    console.log('Saved token is invalid, clearing credentials');
                    await this.logout();
                    return null;
                }
            }
            return null;
        } catch (error) {
            console.error('Failed to load credentials:', error);
            return null;
        }
    }

    /**
     * Logout and clear credentials
     */
    async logout() {
        try {
            await keytar.deletePassword(SERVICE_NAME, ACCOUNT_NAME);
            this.account = null;
            this.minecraftTokenData = null;
        } catch (error) {
            console.error('Failed to clear credentials:', error);
            throw error;
        }
    }

    /**
     * Get current authentication status
     */
    isAuthenticated() {
        return !!this.minecraftTokenData;
    }

    /**
     * Get current Minecraft token for launching the game
     */
    getMinecraftToken() {
        if (!this.minecraftTokenData) {
            return null;
        }
        return this.minecraftTokenData.access_token;
    }
}

module.exports = new MinecraftAuthProvider();
